(function(){function h(){for(var a=[],b=0;5>b;b++){var c=parseInt(24*Math.random());a.push({time:"2016-11-20 21:28:45",address:"\u8fd9\u662f\u6d4b\u8bd5"+String.fromCharCode(64+parseInt(c)),device:String.fromCharCode(64+parseInt(c)),type:.5<Math.random()?0:1,coin:parseInt(30*Math.random()),remainCoin:parseInt(100*Math.random()),status:.9<Math.random()?!1:!0})}return a}function g(){var a=document;this.currPage=0;this.sPos={};this.mPos={};this.selectDevice={};this.currCoinNum=0;this.countDown=3;this.remainCoinEl=a.getElementById("remainCoin");this.btnCoinPriceEl=a.getElementById("btnCoinPrice");this.deviceListDemoText=a.getElementById("deviceListDemo").innerHTML;this.deviceListEl=a.getElementById("deviceList");this.deviceListMainEl=a.getElementById("deviceListMain");this.deviceListMainEl.addEventListener("touchstart",this.deviceListTouchStart.bind(this));this.deviceListMainEl.addEventListener("touchmove",this.deviceListTouchMove.bind(this));this.deviceListMainEl.addEventListener("touchend",this.deviceListTouchEnd.bind(this));this.deviceListSpotEl=a.getElementById("deviceListSpot");this.deviceListUpEl=a.getElementById("deviceListUp");this.deviceListDownEl=a.getElementById("deviceListDown");this.deviceListUpEl.addEventListener("touchstart",this.deviceListUp.bind(this));this.deviceListDownEl.addEventListener("touchstart",this.deviceListDown.bind(this));this.currCoinNumEl=a.getElementById("currCoinNum");this.minusEl=a.getElementById("minus");this.plusEl=a.getElementById("plus");this.minusEl.addEventListener("touchstart",this.minusCoinNum.bind(this));this.plusEl.addEventListener("touchstart",this.plusCoinNum.bind(this));this.coinNumBtnEl=a.getElementById("coinNumBtn");this.coinNumBtnEl.addEventListener("touchstart",this.putCoin.bind(this));this.feeListDemoText=a.getElementById("feeListDemo").innerHTML;this.buyCoinWinCoinPriceEl=a.getElementById("buy-coin-win-coin-price");this.feeListEl=a.getElementById("feeList");this.feeListEl.addEventListener("touchstart",this.touchFeeList.bind(this));this.confirmBuyWinShowBtn=a.getElementById("confirm-buy-win-show");this.confirmBuyWinShowBtn.addEventListener("touchstart",this.showConfirmBuyWin.bind(this));this.buyCoinWinEl=a.getElementById("buy-coin-win");this.buyCoinWinCloseBtn=a.getElementById("buy-coin-win-close");this.buyCoinWinCloseBtn.addEventListener("touchstart",this.hideBuyCoinWin.bind(this));this.buyCoinWinShowBtn=a.getElementById("buy-coin-win-show");this.buyCoinWinShowBtn.addEventListener("touchstart",this.showBuyCoinWin.bind(this));this.successPutCoinEl=a.getElementById("success-put-coin");this.successBuyEl=a.getElementById("success-buy");this.coinInsufficientEl=a.getElementById("coin-insufficient");this.confirmBuyWinEl=a.getElementById("confirm-buy-win");this.confirmBuyWinEl.getElementsByClassName("win-close")[0].addEventListener("touchstart",this.hideConfirmBuyWin.bind(this));this.confirmBuyWinEl.getElementsByClassName("confirm-btn")[0].addEventListener("touchstart",this.toPay.bind(this));this.recordWinEl=a.getElementById("record-win");this.showRecordWinBtn=a.getElementById("record-win-show");this.showRecordWinBtn.addEventListener("touchstart",this.showRecordWinEl.bind(this));this.recordWinEl.getElementsByClassName("retrun-btn")[0].addEventListener("touchstart",this.hideRecordWinEl.bind(this));this.recordUpBtn=this.recordWinEl.getElementsByClassName("up-btn")[0];this.recordDownBtn=this.recordWinEl.getElementsByClassName("down-btn")[0];this.recordUpBtn.addEventListener("touchstart",this.recordUp.bind(this));this.recordDownBtn.addEventListener("touchstart",this.recordDown.bind(this));this.DialogLoading=a.getElementById("DialogLoading");this.getRecordListDemo=function(){return document.getElementById("recordListDemo")};this.aboutBtn=a.getElementsByClassName("about-box-a")[0];this.aboutBtn.addEventListener("touchstart",this.showAboutWin.bind(this));this.aboutWin=a.getElementById("about-win");this.aboutWin.getElementsByClassName("retrun-btn")[0].addEventListener("touchstart",this.hideAboutWin.bind(this))}var k={deviceList:[],coinNum:1,coinPrice:200,deviceType:0,maxCoinCount:30,remainCoin:10,deviceId:10,feeList:[],auth_token:"11111"};userData=userData||k;var f={deviceId:"deviceId",deviceName:"deviceMark",coinNum:"pulseNum",status:"isOnLine",maxCoinCount:"maxCoinThreshold"};g.prototype={parseFee:function(a){a&&""!=a&&(a=a%100?parseFloat(a/100).toFixed(2):parseInt(a/100));return a},init:function(){this.setDeviceListBox();this.setDeviceListSpotList();this.closeLoading();this.initFeeList();this.setRemainCoin();this.setCoinPrice();this.initDeviceList();this.setDeviceListActive(userData.deviceId)},setCoinPrice:function(){this.btnCoinPriceEl.innerText=this.parseFee(userData.coinPrice);this.buyCoinWinCoinPriceEl.innerText=this.parseFee(userData.coinPrice)},setDeviceListBox:function(){for(var a=this.deviceListMainEl.parentNode.offsetWidth,b=Math.ceil(userData.deviceList.length/9),c=0;c<b;c++){var d=document.createElement("div");d.className="list-main-box-child list-main-box-child"+c;d.style.width=a+"px";this.deviceListEl.appendChild(d)}},setRemainCoin:function(){this.remainCoinEl.innerText=userData.remainCoin||0;userData.remainCoin||this.showBuyCoinWin()},initDeviceList:function(){var a=userData.deviceList,b=a.length,c=this.findDeviceIndexInList(userData.deviceId);9<b&&(3<c&&c<b-4?(this.currPage=parseInt((c+4)/9),a=a.slice(c-4,c+5)):3<c&&c>=b-4?(this.currPage=parseInt(b/9),a=a.slice(b-9,b)):a=a.slice(0,9));this.setDeviceList(a);this.setDeviceListSpotActive(this.currPage)},initFeeList:function(){for(var a=this.feeListDemoText,b=[],c=userData.feeList,d=userData.coinPrice,f=c.length,e=0;e<f;e++){var g=c[e].ecNum-Math.ceil(c[e].fee/d),h=0<g?"inline-block":"none",g=a.replace(/{{fee}}/g,this.parseFee(c[e].fee)).replace(/{{pulseNum}}/g,c[e].ecNum).replace(/{{index}}/g,e).replace(/{{giveNum}}/g,g).replace(/{{display}}/g,h);b.push(g)}this.feeListEl.innerHTML=b.join("")||"\u6682\u65e0\u5957\u9910";this.initFeeListSelect();0<f&&this.setFeeListActive(0)},initFeeListSelect:function(){for(var a=this.feeListEl.children,b=a.length,c=0;c<b;c++)a[c].className=a[c].className.replace(/active/g,"")},setFeeListActive:function(a){this.feeListEl.children[a].className+=" active";this.selectFee=userData.feeList[a]},touchFeeList:function(a){a.preventDefault();a=a.target;-1<a.className.indexOf("fee-info")&&(a=a.getAttribute("index"),this.initFeeListSelect(),this.setFeeListActive(a))},setDeviceList:function(a,b){for(var c=a.length,d=[],g=this.deviceListDemoText,e=0;e<c;e++){var h=g.replace(/{{index}}/g,a[e][f.deviceId]).replace(/{{deviceName}}/g,a[e][f.deviceName]).replace(/{{coinNum}}/g,a[e][f.coinNum]).replace(/{{disable}}/g,a[e][f.status]?"":"disable");d.push(h)}0<c&&(c=this.deviceListEl.getElementsByClassName("list-main-box-child"+this.currPage)[0],c.innerHTML=d.join(""),this.deviceListEl.style.transition=b?"left .5s":"none",this.deviceListEl.style.left=-(parseInt(c.offsetWidth)*this.currPage)+"px");this.selectDevice={};this.currCoinNum=0;this.setCoinNum()},setDeviceListSpotList:function(){for(var a=Math.ceil(userData.deviceList.length/9),b=[],c=0;c<a;c++)b.push('\x3cdiv class\x3d"spot"\x3e\x3c/div\x3e');this.deviceListSpotEl.innerHTML=b.join("");this.deviceListSpotEl.style.left=(this.deviceListSpotEl.parentNode.offsetWidth-this.deviceListSpotEl.offsetWidth)/2+"px"},setDeviceListSpotActive:function(a){for(var b=this.deviceListSpotEl.children,c=b.length,d=0;d<c;d++)b[d].className="spot";b[a]&&(b[a].className="spot active")},findDeviceIndexInList:function(a){for(var b=userData.deviceList,c=b.length,d=0;d<c;d++)if(b[d][f.deviceId]==a)return d},setDeviceListActive:function(a){if(0!=this.deviceListEl.children.length)for(var b=this.deviceListEl.getElementsByClassName("list-main-box-child"+this.currPage)[0].children,c=b.length,d=0;d<c;d++)if(b[d].className=b[d].className.replace(/active/g,""),b[d].getAttribute("index")==a){if(!this.getDevice(a)[f.status])break;this.selectDevice=this.getDevice(a);this.currCoinNum=this.selectDevice[f.coinNum];this.setCoinNum();b[d].className+=" active"}},getDevice:function(a){for(var b=userData.deviceList,c=b.length,d=0;d<c;d++)if(b[d][f.deviceId]==a)return b[d]},deviceListUp:function(a){a&&a.preventDefault();0!=this.currPage&&(this.currPage--,this.isBtnShow(),this.changeDeviceListUp())},deviceListDown:function(a){a&&a.preventDefault();this.currPage!=Math.ceil(userData.deviceList.length/9)-1&&(this.currPage++,this.isBtnShow(),this.changeDeviceListDown())},isBtnShow:function(){this.deviceListUpEl.style.opacity=0==this.currPage?.2:1;this.deviceListDownEl.style.opacity=this.currPage==Math.ceil(userData.deviceList.length/9)-1?.2:1},changeDeviceListUp:function(){var a=userData.deviceList;if(0!==a.length){var b=this.deviceListEl.getElementsByClassName("list-main-box-child"+(this.currPage+1))[0].children[0].getAttribute("index"),b=this.findDeviceIndexInList(b),a=9<b?a.slice(b-9,b):a.slice(0,9);this.setDeviceList(a,"right");this.setDeviceListSpotActive(this.currPage)}},changeDeviceListDown:function(){var a=userData.deviceList;if(0!==a.length){var b=this.deviceListEl.getElementsByClassName("list-main-box-child"+(this.currPage-1))[0],b=b.children[b.children.length-1].getAttribute("index"),b=this.findDeviceIndexInList(b),a=9<a.length-b?a.slice(b+1,b+10):a.slice(a.length-9,a.length);this.setDeviceList(a,"left");this.setDeviceListSpotActive(this.currPage)}},deviceListTouchStart:function(a){a.preventDefault();a=a.touches?a.touches[0]:a;this.sPos.x=a.screenX;this.mPos.x=a.screenX},deviceListTouchMove:function(a){a.preventDefault();this.mPos.x=(a.touches?a.touches[0]:a).screenX},deviceListTouchEnd:function(a){a.preventDefault();var b=this.sPos.x-this.mPos.x;50<Math.abs(b)?0<b?this.deviceListDown():this.deviceListUp():10>Math.abs(b)&&(a=a.target,b=a.className,-1===b.indexOf("list-box")||-1<b.indexOf("disable")||(a=a.getAttribute("index"),this.setDeviceListActive(a)))},setCoinNum:function(){this.currCoinNumEl.innerText=this.currCoinNum?this.currCoinNum+"\u5e01":"?"},minusCoinNum:function(a){a&&a.preventDefault();this.currCoinNum&&this.currCoinNum!=this.selectDevice[f.coinNum]&&(this.currCoinNum-=this.selectDevice[f.coinNum],this.setCoinNum())},plusCoinNum:function(a){a&&a.preventDefault();this.currCoinNum&&this.currCoinNum!=this.selectDevice[f.maxCoinCount]&&(this.currCoinNum+=this.selectDevice[f.coinNum],this.setCoinNum())},putCoinSuccess:function(){this.closeLoading();var a=this.successPutCoinEl.getElementsByClassName("pleaseBuyCoin")[0],b=this.successPutCoinEl.getElementsByClassName("device")[0],c=this.successPutCoinEl.getElementsByClassName("coin")[0];userData.remainCoin-=this.currCoinNum;0===userData.remainCoin?(a.style.display="block",this.showBuyCoinWin()):a.style.display="none";b.innerText=this.selectDevice.deviceName;c.innerText=this.currCoinNum;this.setRemainCoin();this.successPutCoinEl.style.display="block";this.hideWin(this.successPutCoinEl,3);this.currCoinNum=this.selectDevice[f.coinNum];this.setCoinNum()},hideWin:function(a,b){a.getElementsByClassName("countDown")[0].innerText=b+"s";a.style.opacity=1;setTimeout(function(){1>=b?(a.style.opacity=0,setTimeout(function(){a.style.display="none"},200)):(b--,this.hideWin(a,b))}.bind(this),1E3)},showBuyCoinWin:function(a){a&&a.preventDefault();a=userData.feeList.length;this.initFeeListSelect();0<a&&this.setFeeListActive(0);this.buyCoinWinEl.style.display="block"},hideBuyCoinWin:function(a){a&&a.preventDefault();this.buyCoinWinEl.style.display="none"},showConfirmBuyWin:function(a){a.preventDefault();this.hideBuyCoinWin();a=this.confirmBuyWinEl.getElementsByClassName("feeNum")[0];var b=this.confirmBuyWinEl.getElementsByClassName("coinNum")[0];a.innerText=this.parseFee(this.selectFee.fee);b.innerText=this.selectFee.ecNum;this.confirmBuyWinEl.style.display="block"},hideConfirmBuyWin:function(a){a&&a.preventDefault();this.confirmBuyWinEl.style.display="none"},showLoading:function(){this.DialogLoading.style.display="block"},closeLoading:function(){this.DialogLoading.style.display="none"},showPaySuccessDialog:function(a){a=this.successBuyEl.getElementsByClassName("coin")[0];var b=this.successBuyEl.getElementsByClassName("time")[0],c=this.successBuyEl.getElementsByClassName("date")[0];a.innerText=this.selectFee.ecNum;b.innerText="\u4e09\u4e2a\u6708";c.innerText="2016\u5e7412\u670812\u65e5";this.successBuyEl.style.display="block";this.hideWin(this.successBuyEl,3)},_recordLoadingStart:0,_recordLoadingCount:5,_currPageRecord:0,_recordLoading:!1,_recordLoadingLast:!1,_isLoading:!1,showRecordWinEl:function(a){a.preventDefault();this.recordWinEl.style.display="block";this._recordLoading||(this._currPageRecord=1,this.loadRecordList(this._recordLoadingStart,this._recordLoadingCount))},hideRecordWinEl:function(a){a.preventDefault();this.recordWinEl.style.display="none"},setRecordList:function(a){if(a){var b=a.total||20;this._recordLoading=!0;this._recordLoadingLast=this._recordLoadingStart>b?!0:!1;this.setBtnStaus();this._isLoading=!1;var b=this.getRecordListDemo().innerHTML,c=this.recordWinEl.getElementsByClassName("record-list-box")[0],d=[];a=a.list||a;for(var f=a.length,e=0;e<f;e++){var g=b.replace(/{{time}}/g,a[e].time).replace(/{{address}}/g,a[e].address).replace(/{{device}}/g,a[e].device).replace(/{{type}}/g,a[e].type?"\u6295\u5e01":"\u8d2d\u5e01").replace(/{{coin}}/g,a[e].coin).replace(/{{display_error}}/g,a[e].status?"none":"block").replace(/{{remainCoin}}/g,a[e].remainCoin).replace(/{{status}}/g,a[e].status?"\u6210\u529f":"\u5f85\u5904\u7406");d.push(g)}c.innerHTML=d.join("")}},recordUp:function(a){a.preventDefault();1==this._currPageRecord||this._isLoading||(this._currPageRecord--,this._recordLoadingStart-=this._recordLoadingCount,this.loadRecordList(this._recordLoadingStart,this._recordLoadingCount))},recordDown:function(a){a.preventDefault();this._recordLoadingLast||this._isLoading||(this._currPageRecord++,this._recordLoadingStart+=this._recordLoadingCount,this.loadRecordList(this._recordLoadingStart,this._recordLoadingCount))},setBtnStaus:function(){this.recordUpBtn.className=1==this._currPageRecord?this.recordUpBtn.className+" disable":this.recordUpBtn.className.replace("disable","");this.recordDownBtn.className=this._recordLoadingLast?this.recordDownBtn.className+" disable":this.recordUpBtn.className.replace("disable","")},showEorreWin:function(a){var b=document.getElementById("error-win");b.getElementsByClassName("msg")[0].innerText=a||"";b.style.display="block";this.hideWin(b,1.5)}};g.prototype.parseData=function(a){var b=[],c;for(c in a)b.push(c+"\x3d"+a[c]);return b.join("\x26")};g.prototype.toPay=function(a){a.preventDefault();var b=this;a={deviceId:userData.deviceId,deviceMac:userData.deviceMac,openId:userData.openId,auth_token:userData.auth_token,feeBusinessDetailId:b.selectFee.id};this.showLoading();this.hideConfirmBuyWin();util.ajax({url:"./payment/buyEcByWechat",type:"POST",async:!0,data:this.parseData(a),headers:{"Content-Type":"application/x-www-form-urlencoded"},success:function(a){a=JSON.parse(a);b.closeLoading();console.log(a.code);"200"!==a.code?b.showEorreWin(a.msg):WeixinJSBridge.invoke("getBrandWCPayRequest",a.result,function(a){"get_brand_wcpay_request:ok"==a.err_msg&&(userData.remainCoin+=parseInt(b.selectFee.ecNum),b.showPaySuccessDialog(),b.setRemainCoin())})},error:function(a){console.log(a)}})};g.prototype.putCoin=function(a){a&&a.preventDefault();a=f;if(this.selectDevice[a.deviceId])if(userData.remainCoin<this.currCoinNum)this.coinInsufficientEl.style.display="block",this.hideWin(this.coinInsufficientEl,3);else{this.showLoading();a=f;var b=this;util.ajax({url:"./payment/toEcPay",type:"POST",async:!0,data:this.parseData({deviceMac:userData.deviceMac,proprietorId:userData.proprietorId,addressId:userData.addressId,auth_token:userData.auth_token,openId:userData.openId,count:this.currCoinNum,deviceId:this.selectDevice[a.deviceId]}),headers:{"Content-Type":"application/x-www-form-urlencoded"},success:function(a){a=JSON.parse(a);b.closeLoading();console.log(a.code);"200"!==a.code?b.showEorreWin(a.msg):b.putCoinSuccess()},error:function(a){console.log(a)}})}else this.countDown=1.5,this.showEorreWin("\u8bf7\u9009\u62e9\u8bbe\u5907")};g.prototype.loadRecordList=function(a,b){this.showLoading();this._isLoading=!0;var c=this,d={openId:userData.openId,start:a,count:b,deviceId:this.selectDevice[f.deviceId]};h();util.ajax({url:"getRecordList",type:"POST",async:!0,data:this.parseData(d),headers:{"Content-Type":"application/x-www-form-urlencoded"},success:function(a){a=JSON.parse(a);c.closeLoading();console.log(a.code);"200"!==a.code?c.showEorreWin(a.msg):(c.setRecordList(a),c.closeLoading())},error:function(a){console.log(a)}})};g.prototype.showAboutWin=function(a){a.preventDefault();this.aboutWin.style.display="block";var b=this.aboutWin.getElementsByClassName("about-content")[0],c=this;""==b.innerHTML&&(this.showLoading(),util.ajax({url:"./xingnaiji/about.html",type:"GET",async:!0,data:{},headers:{"Content-Type":"application/x-www-form-urlencoded"},success:function(a){c.closeLoading();console.log(a);b.innerHTML=a.toString()},error:function(a){c.closeLoading();console.log(a)}}))};g.prototype.hideAboutWin=function(a){this.aboutWin.style.display="none"};document.addEventListener("DOMContentLoaded",function(){(new g).init()},!1)})();