<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="expires" content="0">
		<meta name="viewport" content="user-scalable=0" />
		<meta name="viewport"
			content="width=device-width, initial-scale=1, maximum-scale=1">
		<title>手机充值</title>
		<style>
* {
	padding: 0;
	margin: 0 auto;
	font-family: "微软雅黑";
	-webkit-font-smoothing: antialiased; /* 字体抗锯齿*/
}

body {
	padding: 0;
	margin: 0;
	text-align: center;
}

header,header img,section,footer {
	width: 100%;
}

header img {
	vertical-align: middle;
}

.phone_main {
	width: 90%;
	padding: 3% 0;
	text-align: left;
}

.phone_text {
	width: 70%;
	border: 1px #0085d0 solid;
	padding: 2% 2%;
	-webkit-border-radius: 5px;
	-moz-border-radius: 5px;
	border-radius: 5px;
	text-align: center;
}

.context {
	width: 100%;
	text-align: center;
	margin: 0 auto;
}

.number_list_main {
	text-align: left;
	width: 100%;
}

.number_box {
	text-align: center;
	float: left;
}

.clear {
	clear: both;
}

.phone_text_option {
	width: 90%;
	margin: 0 auto;
}

#phone_text_arrivalNb {
	display: none;
}

.number_box {
	border: 1px solid #e9e9e9;
	width: 22%;
	margin: 1% 4%;
	padding: 1%;
	-webkit-border-radius: 2px;
	-moz-border-radius: 2px;
	border-radius: 2px;
}

.number_box_h1 {
	font-weight: 700;
}

.number_box_span {
	color: crimson;
}

.btn_main {
	width: 100%;
}

.btn_main p {
	text-align: left;
}

.btn {
	background-color: #0085d0;
	width: 90%;
	border: 0;
	color: #fff;
	padding: 3% 0;
	-webkit-border-radius: 5px;
	-moz-border-radius: 5px;
	border-radius: 5px;
	margin-top: 10px;
}

.apart {
	width: 100%;
	background: #f3eded;
	margin: 5% auto;
}

.help {
	width: 100%;
}

.help_text {
	width: 100%;
	text-align: left;
}

.help_text ul {
	list-style: none;
	width: 90%;
}

/*遮罩*/
.shade {
	background-color: rgba(0, 0, 0, 0.5);
	width: 100%;
	position: fixed;
	top: 0;
	left: 0;
	display: none;
}

.pop_window {
	background: #fff;
	width: 70%;
	border-radius: 5px;
	position: fixed;
	top: 30%;
	left: 10%;
	padding: 0 5%;
}

.pop_window .close {
	position: absolute;
	right: 2%;
	top: 2%;
	width: 10%;
}

.pop_window .close img {
	width: 100%;
}

.btn_70 {
	width: 70%;
}

.btn_40 {
	width: 40%;
}

.btn_45 {
	width: 45%;
}

.btn_50 {
	width: 50%;
}

.pop_content {
	padding: 10% 10%;
}

.pop_window .btn_list {
	padding: 5% 0;
}

.pop_content p {
	text-align: left;
}

#phone_error p {
	text-align: center;
}

#discount_over .pop_content {
	padding: 10% 5%;
}

#discount_used .pop_content {
	padding: 5% 10%;
}

.shade_img {
	width: 50%;
	position: fixed;
	top: 0;
	right: 0;
}

/*#loading img{*/ /*position: fixed;*/ /*top: 45%;*/ /*left: 45%;*/
	/*width: 10%;*/ /*}*/
#checkbox_style {
	color: #0085d0;
}

#checkbox_main {
	padding: 10% 0;
}

#checkbox_main hr {
	background-color: #eeeeee;
}

#loading img {
	width: 100%;
	margin-bottom: 10%;
}

.loading_img {
	width: 90%;
}
</style>
	</head>
	<body>
		<script src="js/jquery.min.js">
</script>
		<script type="text/javascript"
			src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js">
</script>
		<script src="js/wechar.js">
</script>
		<header>
		<img src="img/top.png" alt="" />
		</header>
		<section>
		<div class="context">
			<div class="phone_main">
				<span class="font_size25 ">充值号码：</span>
				<input type="text" class="phone_text font_size22" id="phone"
					placeholder="请输入号码" onchange="isPhone()" />
			</div>
			<div class="number_list_main">
				<p class="font_size25 phone_text_option">
					充值金额：
				</p>
				<div class="number_list">
					<div id="number50" class="number_box" onclick="choice(50)">
						<p class="number_box_h1 font_size22 number_line">
							50元
						</p>
						<p class="font_size30 number_line number50_p">
							实际到账
							<span id="number50_span" class="number_box_span">50</span>元
						</p>
					</div>
					<div id="number100" class="number_box" onclick="choice(100)">
						<p class="number_box_h1 font_size22 number_line">
							100元
						</p>
						<p class="font_size30 number_line">
							实际到账
							<span id="number100_span" class="number_box_span">100</span>元
						</p>
					</div>
					<div id="number300" class="number_box" onclick="choice(300)">
						<p class="number_box_h1 font_size22 number_line">
							300元
						</p>
						<p class="font_size30 number_line">
							实际到账
							<span id="number300_span" class="number_box_span">300</span>元
						</p>
					</div>

					<div class="clear"></div>
				</div>
			</div>
			<div class="btn_main">
				<p class="font_size25 phone_text_option" id="phone_text_arrivalNb">
					实际支付
					<span class="number_box_span" id="actualNb"></span>元 到账
					<span class="number_box_span" id="arrivalNb"></span>元
				</p>
				<button class="btn font_size25" onclick="pay()">
					立即充值
				</button>
			</div>
		</div>
		<div class="apart">
		</div>
		<div class="help ">
			<div class="help_text">
				<p class="font_size25 phone_text_option">
					活动规则：
				</p>
				<ul class="font_size28">
					<li class="number_line3">
						1、活动时间：10月26日—10月31日；
					</li>
					<li class="number_line3">
						2、活动对象：深圳移动全网客户（欠费、停机、4G随心王、 无限量流量套餐用户除外）；
					</li>
					<li class="number_line3">
						3、活动渠道：“深圳移动”微信公众号或“深圳移动营业 厅”APP；
					</li>
					<li class="number_line3">
						4、参与方式：
						<p>
							（1）关注“深圳移动”微信公众号，进入“优惠充值”菜单；
						</p>
						<p>
							（2）输入充值号码，选择充值金额，并完成相关微信支付流 程，即可完成充值；
						</p>
					</li>
					<li class="number_line3">
						5、活动规则：
						<p>
							（1）“9折”充值优惠：客户选择不同档次的金额充值，需微信 支付相应金额，同时额外赠送一定额度的话费。例如：选择
							100元金额参与相当于9折左右的充值优惠，实际支付100元，到账112元（基本 账户到账100元+赠送账户到账12元）；
						</p>
						<p>
							（2）活动期间，每个微信ID/手机号码仅限享受一次本优惠 ；
						</p>
						<p>
							（3）充值成功后，充值话费与赠送话费将于72小时内到账；
						</p>
						<p>
							（4）本活动最终解释权归深圳移动所有。
						</p>
					</li>
				</ul>
			</div>
		</div>
		</section>
		<!-- 号码有误-->
		<div class="pop_main shade" id="phone_error">
			<div class="pop_window">
				<div class="close">
					<img src="img/close.png" alt="" />
				</div>
				<p class="pop_option font_size22">
					温馨提示
				</p>
				<hr />
				<div class="pop_content">
					<p class="font_size22">
						请输入正确的
					</p>
					<p class="font_size22">
						深圳移动手机号码
					</p>
				</div>
				<div class="btn_list">
					<button class="btn btn_70 font_size22 " onclick="hiddShade()">
						重新输入
					</button>
				</div>
			</div>
		</div>
		<!-- 没有选择金额 -->
		<div class="pop_main shade" id="nb_not">
			<div class="pop_window">
				<div class="close">
					<img src="img/close.png" alt="" />
				</div>
				<p class="pop_option font_size22">
					温馨提示
				</p>
				<hr />
				<div class="pop_content">
					<p class="font_size22">
						请选择需要充值的金额
					</p>
				</div>
				<div class="btn_list">
					<button class="btn btn_70 font_size22 " onclick="hiddShade()">
						选择金额
					</button>
				</div>
			</div>
		</div>
		<!-- 不能参加-->
		<div class="pop_main shade" id="discount_not">
			<div class="pop_window">
				<div class="close">
					<img src="img/close.png" alt="" />
				</div>
				<p class="pop_option font_size22">
					温馨提示
				</p>
				<hr />
				<div class="pop_content">
					<p class="font_size22">
						您的号码不能参加本充值
					</p>
					<p class="font_size22">
						优惠，是否继续充值（无赠
					</p>
					<p class="font_size22">
						送话费）？
					</p>
				</div>
				<div class="btn_list">
					<button class="btn btn_40 font_size22 " onclick="hiddShade()">
						继续充值
					</button>
					<button class="btn btn_40 font_size22 " onclick="hiddShade()">
						不充值
					</button>
				</div>
			</div>
		</div>
		<!-- 已经参加 -->
		<div class="pop_main shade" id="phone_not">
			<div class="pop_window">
				<div class="close">
					<img src="img/close.png" alt="" />
				</div>
				<p class="pop_option font_size22">
					温馨提示
				</p>
				<hr />
				<div class="pop_content">
					<p class="font_size22">
						您的微信号或手机号已经参加过本优惠， 每个微信用户或手机号码仅限参与一次，是否继续充值（无赠送话费）？
					</p>
				</div>
				<div class="btn_list">
					<button class="btn btn_40 font_size22 " onclick="hiddShade()">
						继续充值
					</button>
					<button class="btn btn_40 font_size22 " onclick="hiddShade()">
						不充值
					</button>
				</div>
			</div>
		</div>
		<!-- 已经抢完-->
		<div class="pop_main shade" id="discount_over">
			<div class="pop_window">
				<div class="close">
					<img src="img/close.png" alt="" />
				</div>
				<p class="pop_option font_size22">
					温馨提示
				</p>
				<hr />
				<div class="pop_content">
					<p class="font_size22">
						本月充值优惠名额已抢完。 您可继续充值
						<span class="pop_content_num"></span>元（无赠送话费），是否继续充值？
					</p>
				</div>
				<div class="btn_list">
					<button class="btn btn_40 font_size22 " onclick="keepPay()">
						继续充值
					</button>
					<button class="btn btn_40 font_size22 " onclick="hiddShade()">
						不充值
					</button>
				</div>
			</div>
		</div>
		<!-- 已经使用-->
		<div class="pop_main shade" id="discount_used">
			<div class="pop_window">
				<div class="close">
					<img src="img/close.png" alt="" />
				</div>
				<p class="pop_option font_size22">
					温馨提示
				</p>
				<hr />
				<div class="pop_content">
					<p class="font_size22">
						您的微信号或手机号已经参加过本优惠， 每个微信用户仅限参与一 次，是否继续充值
						<span class="pop_content_num"></span>元 （无话费赠送）?
					</p>
				</div>
				<div class="btn_list">
					<button class="btn btn_45 font_size22 " onclick="keepPay()">
						继续充值
					</button>
					<button class="btn btn_50 font_size22 " onclick="getShare()">
						告诉好友抢"9折"
					</button>
				</div>
			</div>
		</div>
		<!-- 支付-->
		<div class="pop_main shade" id="pay">
			<div class="pop_window">
				<div class="close">
					<img src="img/close.png" alt="" />
				</div>
				<p class="pop_option font_size22">
					是否充值
					<span id="pay_number"></span>元话费
				</p>
				<hr />
				<div class="pop_content" id="checkbox_main">
					<p class="font_size22">
						选择支付方式
					</p>
					<hr />
					<p class="font_size22" id="checkbox_style">
						<input type="checkbox" id="checkbox_btn">
						微信支付
					</p>
				</div>
				<div class="btn_list">

					<!--<input class="btn btn_70 font_size22 " type="submit" value="确认支付"/>-->
					<button class="btn btn_70 font_size22 " onclick="getPay()">
						确认支付
					</button>

				</div>
			</div>
		</div>
		<div class="shade" id="share">
			<img class="shade_img" src="img/share.png" alt="" />
		</div>
		<div class="shade" id="loading">
			<div class="pop_window">
				<p class="pop_option font_size22">
					温馨提示
				</p>
				<hr />
				<div class="pop_content">
					<p class="font_size22">
						处理中，请等候（请勿关闭页面）
					</p>
				</div>
				<div class="loading_img">
					<img src="img/load.gif" alt="" />
				</div>
			</div>
		</div>

		<form style="display: none" action="rechargeHandle.action"
			id="pay_form" method="get">
			<input type="hidden" value="" name="price" id="price" />
			<input type="hidden" value="" name="number" id="number" />
			<input type="hidden" value="" name="productName" id="productName" />
			<input type="hidden" value="" name="mobileNum" id="mobileNum" />
			<input type="hidden" value="" name="openId" id="openId" />
			<input type="hidden" value="" name="disCount" id="disCount" />
		</form>
		<script>
<!-- view-->
        var window_data = {
            window_width : document.body.scrollWidth,
            window_height : document.body.scrollHeight
        };
        var  user_data = {
//            手机
            phone: "",
//            实际到账
            arrivalNb: 0,
//            实际支付
            actualNb: 0,
//            是否优惠
            isDiscount: true,
            isSZPhone: false,
            discount: 0.9,
            discount_over: false,
            discount_used: false,
            productName:""
        };
        var discount_list = {
            number50_span: "number50_span",
            number100_span: "number100_span",
            number300_span: "number300_span",
            discount50 : 56,
            discount100 : 112,
            discount300 : 334
        };

        window_data.font_size22 = window_data.window_width / 22;
        window_data.font_size25 = window_data.window_width / 25;
        window_data.font_size31 = window_data.window_width / 40;
        window_data.font_size28 = window_data.window_width / 28;
        window_data.line_height = window_data.window_width / 8;
        window_data.line_height2 = window_data.window_width / 12;
        window_data.line_height3 = window_data.window_width / 15;
        $("body").css("font-size" , window_data.font_size22);
        $(".font_size22").css("font-size" , window_data.font_size22);
        $(".font_size25").css("font-size" , window_data.font_size25);
        $(".font_size28").css("font-size" , window_data.font_size28);
        $(".font_size30").css("font-size" , window_data.font_size31);
        $(".phone_text_option").css("line-height", window_data.line_height +"px");
        $(".number_line").css("line-height", window_data.line_height2 +"px");
        $(".number_line3").css("line-height", window_data.line_height3 +"px");
        $(".apart").css("height", window_data.line_height2 +"px");
        $(".shade").css("height", window_data.window_height);
        $(".pop_option").css("line-height", window_data.line_height +"px");
        $(".pop_content").css("line-height", window_data.line_height2 +"px");
        $("#checkbox_btn").css("width", window_data.font_size22 )
                .css("height", window_data.font_size22 );
        $("#checkbox_btn").attr("checked",true);
//        隐藏遮罩
        var  hiddShade = function(){
            $(".shade").hide();
        };
        $(".close").click(function(){
            hiddShade();
        } );
        $("#share").click(function(){
            $("#share").hide();
        });
        //显示分享
        var getShare = function(){
            $("#share").show();
        };
        //选择支付金额
        function choice(actualNb){
            $("#phone_text_arrivalNb").show();
            if(actualNb)
            {
                $(".number_box").css("border", "1px #e9e9e9 solid");
                $("#number"+actualNb).css("border", "1px #0085d0 solid");
                //实际支付
                user_data.actualNb = actualNb;
                //到账
                var nb = $("#number"+actualNb+"_span").html();
                user_data.arrivalNb = parseInt(nb);
                $("#actualNb").html(user_data.actualNb);
                $("#arrivalNb").html(user_data.arrivalNb);
                user_data.productName = actualNb + "元话费";
                $(".pop_content_num").html(actualNb);
            }
        }

        // 入口统计
        function count(){
            var arr = wechar.href.split("?")[1];
            var arr2 = arr.split("&");
            var count_name = "";
            for(var i = 0; i < arr2.length; i++){
                if(arr2[i].split("=")[0] == "actionfrom"){
                    count_name = arr2[i].split("=")[1];
                }
            }
            if(count_name != ""){
                $.ajax({
                    type:"GET",
                    url:"addInvolvedUser.action",
                    data:{actionfrom:count_name,openId:wechar.open_id},
                    dataType:"json",
                    success: function(data){

                    }
                });
            }
        }

        count();


        //有优惠
        function getDiscount(){
            if(user_data.isDiscount){
                $("#"+discount_list.number50_span).html(discount_list.discount50);
                $("#"+discount_list.number100_span).html(discount_list.discount100);
                $("#"+discount_list.number300_span).html(discount_list.discount300);
            }
        }
        getDiscount();
        //没有优惠
        function getDiscount_false(){
            if(!user_data.isDiscount){
                $("#"+discount_list.number50_span).html(50);
                $("#"+discount_list.number100_span).html(100);
                $("#"+discount_list.number300_span).html(300);
            }
        }

        //判断是否是手机
        var isPhone = function(){
            user_data.phone = $("#phone").val();
            if(!user_data.phone.match(/^(0|86|17951)?(13[0-9]|15[012356789]|17[678]|18[0-9]|14[57])[0-9]{8}$/)){
                $("#phone_error").show();
            }else{
                $("#loading").show();
                getPhone();
            }
        };

        //        号码详情
        function getPhone() {
            $.ajax({
                url:"checkIsHaveRecharge.action",
                type:"GET",
                data: {mobileNum:user_data.phone,openId:wechar.open_id},
                dataType:"json",
                success: function(data){
                    setPhone(data);
                }
            });
        }
        //    判断号码状态
        function setPhone(data){
//            隐藏所有遮罩层
            hiddShade();
            if(data){
                if(data["flag"] == true)
                {
                    //如果是深圳移动号码
                    if(data["result"] == 1){
                        user_data.isSZPhone = true;
                        user_data.isDiscount = true;
                        getDiscount();
                    }
                }else if(data["flag"] == false){

                    user_data.isDiscount = false;
                    user_data.isSZPhone = true;

                    if(data["result"] == -1){
//                       已有过优惠
                        user_data.discount_used = true;
                        $("#phone_not").show();

                    }else if(data["result"] == -2 ){
//                        手机号码不可用
                        $("#phone_error").show();
                        user_data.isSZPhone = false;
                    }else if( data["result"] == -3){
//                        该手机号无优惠
                        $("#discount_not").show();

                    }else if(data["result"] == -4){
//                        活动结束
                        user_data.discount_over = true;
                    }else{
                    //   手机号码不可用
                        $("#phone_error").show();
                        user_data.isSZPhone = false;
                   		// alert("号码异常");
                        //user_data.discount_over = true;
                    }
                    getDiscount_false();
                }else{
                    alert("网络繁忙");
                }
            }
        }
        function keepPay(){
            $(".shade").hide();
            $("#pay_number").html(user_data.actualNb);
            $("#pay").show();
        }
 //      支付详情
        function pay(){
 //            优惠名额是否抢完
//            $("#loading").show();
            if(user_data.actualNb != 0){
                if(user_data.isSZPhone){
                    if(user_data.discount_over){
                        $("#discount_over").show();
                    }else if(user_data.discount_used){
                        $("#discount_used").show();
                    }else{
                        $("#pay_number").html(user_data.actualNb);
                        $("#pay").show();
                    };
                }else{
                    $("#phone_error").show();
                };
            }else{
                $("#nb_not").show();
            }
        }
//      确认支付
        function getPay(){
            if($("#checkbox_btn").prop("checked")== true){
                var productName = encodeURIComponent(user_data.productName);
                $("#openId").val(wechar.open_id);
                $("#price").val(user_data.actualNb);
                $("#number").val(1);
                $("#productName").val(productName);
                $("#mobileNum").val(user_data.phone);
                if(user_data.isDiscount == false){
                $("#disCount").val(100);
                }else{
                $("#disCount").val(90);
                }
                //清空phone
                $("#phone").val("");
                var form_obj = document.getElementById("pay_form");
                form_obj.submit();
            }else{
                alert("请选择支付方式");
            };
        }
    </script>
	</body>
</html>